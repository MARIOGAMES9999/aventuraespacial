<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aventura Espacial</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
    }
    #pauseButton {
      position: fixed;
      top: 10px;
      right: 10px;
      cursor: pointer;
      z-index: 2;
    }
    /* Menú principal */
    #mainMenu, #levelMenu, #helpScreen, #gameOverMenu, #winMenu {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      z-index: 3;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      border: 2px solid white;
    }
    #mainMenu button, 
    #levelMenu button, 
    #helpScreen button, 
    #gameOverMenu button, 
    #winMenu button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    /* Ubicación de botones en el menú principal */
    #mainMenu .menu-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    /* Para el menú de niveles y la pantalla de victoria, los botones se ordenan horizontalmente */
    #levelMenu .menu-buttons, 
    #winMenu .menu-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <!-- Botón de pausa (imagen blanca) -->
  <img id="pauseButton" src="https://uxwing.com/wp-content/themes/uxwing/download/controller-and-music/pause-button-round-white-icon.png" alt="Pause Button" width="30" height="30">

  <!-- Menú principal -->
  <div id="mainMenu">
    <h1>Aventura Espacial</h1>
    <div class="menu-buttons">
      <button id="helpButton">Ayuda</button>
      <button id="playButton">Jugar</button>
      <button id="levelButton">Jugar con niveles</button>
    </div>
    <p>Presiona ENTER para comenzar</p>
  </div>

  <!-- Menú de ayuda -->
  <div id="helpScreen" style="display: none;">
    <h2>Cómo jugar</h2>
    <p>Mueve el cohete espacial usando las flechas arriba y abajo (o manteniéndolas pulsadas) para esquivar los meteoritos que vienen de derecha a izquierda.</p>
    <p>Funciones del juego:</p>
    <ul style="text-align:left;">
      <li><strong>Pausa:</strong> Usa el botón de pausa o la tecla "p" para pausar y reanudar.</li>
      <li><strong>Dificultad progresiva:</strong> Los meteoritos se aceleran conforme transcurre la partida.</li>
      <li><strong>Modo niveles:</strong> En este modo deberás sobrevivir hasta alcanzar el tiempo objetivo.</li>
    </ul>
    <button id="closeHelp">Cerrar</button>
  </div>

  <!-- Menú de Game Over (para el modo puntuación) -->
  <div id="gameOverMenu" style="display: none;">
    <h1>¡Game Over!</h1>
    <p id="finalScore"></p>
    <div class="menu-buttons">
      <button id="menuButton">Volver al menú principal</button>
      <button id="retryButton">Volver a intentar</button>
    </div>
  </div>

  <!-- Menú de selección para jugar con niveles -->
  <div id="levelMenu" style="display: none;">
    <h2>Jugar con niveles</h2>
    <p id="levelInfo"></p>
    <div class="menu-buttons">
      <button id="levelBackButton">Volver</button>
      <button id="levelPlayButton">Jugar</button>
    </div>
  </div>

  <!-- Pantalla de victoria en modo niveles -->
  <div id="winMenu" style="display: none;">
    <h1>¡FELICIDADES!</h1>
    <p id="winMessage"></p>
    <div class="menu-buttons">
      <button id="winMenuButton">Menú principal</button>
      <button id="nextLevelButton">Siguiente nivel</button>
    </div>
  </div>

  <script>
    /* ================= Variables Globales ================= */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Botones e interfaces
    const pauseButton = document.getElementById('pauseButton');
    const mainMenu = document.getElementById('mainMenu');
    const helpScreen = document.getElementById('helpScreen');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const levelMenu = document.getElementById('levelMenu');
    const winMenu = document.getElementById('winMenu');

    const helpButton = document.getElementById('helpButton');
    const playButton = document.getElementById('playButton');
    const levelButton = document.getElementById('levelButton');
    const closeHelp = document.getElementById('closeHelp');
    const menuButton = document.getElementById('menuButton');
    const retryButton = document.getElementById('retryButton');
    const levelBackButton = document.getElementById('levelBackButton');
    const levelPlayButton = document.getElementById('levelPlayButton');
    const winMenuButton = document.getElementById('winMenuButton');
    const nextLevelButton = document.getElementById('nextLevelButton');

    const levelInfo = document.getElementById('levelInfo');
    const finalScoreText = document.getElementById('finalScore');
    const winMessage = document.getElementById('winMessage');

    // Estados y modos de juego
    // gameMode: "score" (modo puntuación) o "niveles" (modo niveles)
    let gameMode = "score";
    // gameState: 'start', 'playing', 'paused', 'gameover', 'win'
    let gameState = 'start';

    // Modo puntuación (endless)
    let score = 0;
    let highScore = Number(localStorage.getItem('highScore')) || 0;
    let recordBeaten = false; // para reproducir música de récord

    // Modo niveles
    let currentLevel = 1;
    let targetTime = 10; // en segundos (Nivel 1: 10 s)
    let levelStartTime = null; // se asigna al iniciar la partida en modo niveles

    // Función para obtener el tiempo objetivo según el nivel
    function getTargetTimeForLevel(level) {
      if(level === 1) return 10;
      if(level === 2) return 15;
      if(level === 3) return 20;
      if(level === 4) return 30;
      if(level === 5) return 40;
      if(level === 6) return 50;
      if(level === 7) return 60;
      if(level === 8) return 75;
      if(level === 9) return 90;
      if(level === 10) return 105;
      return getTargetTimeForLevel(10) + 15 * (level - 10);
    }

    // Imagen del cohete (reemplaza al astronauta)
    const astronautImg = new Image();
    astronautImg.src = "https://cdn-icons-png.flaticon.com/512/3655/3655645.png";

    // Imágenes de meteoritos (se eligen al azar)
    const meteoriteImages = [
      "https://images.vexels.com/media/users/3/203018/isolated/preview/66f32f88385888d8827e7da298df6b77-ilustracion-de-roca-asteroide.png",
      "https://images.vexels.com/media/users/3/203017/isolated/preview/a6684989a6b4564caa310397c9b120af-ilustracion-de-la-orbita-de-un-asteroide.png",
      "https://images.vexels.com/media/users/3/203377/isolated/preview/0aec84665568ad2cda7a4a457eb27410-ilustracion-de-asteroide-de-roca.png",
      "https://images.vexels.com/media/users/3/205156/isolated/preview/97f52f15ce49dcd73b9678708f28cabf-ilustracion-de-la-orbita-de-la-roca-del-asteroide.png"
    ];

    // Objeto cohete
    const astronaut = {
      x: 100,
      y: canvas.height / 2,
      size: 30,
      speed: 5
    };

    // Arrays para meteoritos y estrellas
    let asteroids = [];
    let stars = [];
    createStars(100);

    // Efectos de sonido
    const backgroundMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
    backgroundMusic.loop = true;
    backgroundMusic.volume = 0.2;
    const collisionSound = new Audio('https://www.soundjay.com/misc/sounds/fail-buzzer-01.mp3');
    collisionSound.volume = 0.5;
    // Música de nuevo récord (2 segundos, estilo victoria)
    const victorySound = new Audio('https://www.soundjay.com/button/sounds/button-3.mp3');
    victorySound.volume = 0.7;
    function playVictorySound() {
      victorySound.currentTime = 0;
      victorySound.play();
      setTimeout(() => {
        victorySound.pause();
        victorySound.currentTime = 0;
      }, 2000);
    }

    // Teclas presionadas para movimiento continuo
    const keys = {};
    document.addEventListener('keydown', (e) => {
      if (gameState === 'start' && e.key === 'Enter') startGame();
      else if (gameState === 'gameover' && e.key === 'Enter') startGame();
      else if (gameState === 'playing') {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') keys[e.key] = true;
        if (e.key === 'p' || e.key === 'P') togglePause();
      } else if (gameState === 'paused') {
        if (e.key === 'p' || e.key === 'P') togglePause();
      }
      updateUI();
    });
    document.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') keys[e.key] = false;
    });

    // Crear estrellas para el fondo
    function createStars(num) {
      stars = [];
      for (let i = 0; i < num; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 2,
          speed: Math.random() * 0.5 + 0.2
        });
      }
    }

    /* ================= Funciones de Inicio y Reinicio ================= */
    // Reinicia variables comunes (sin reiniciar highScore en modo score)
    function resetGame() {
      if (gameMode === "score") {
        score = 0;
        recordBeaten = false;
      } 
      asteroids = [];
      astronaut.y = canvas.height / 2;
      keys['ArrowUp'] = false;
      keys['ArrowDown'] = false;
      if(gameMode === "niveles") {
        levelStartTime = Date.now();
      }
    }

    // Inicia el juego según el modo
    function startGame() {
      resetGame();
      gameState = 'playing';
      mainMenu.style.display = 'none';
      gameOverMenu.style.display = 'none';
      helpScreen.style.display = 'none';
      levelMenu.style.display = 'none';
      winMenu.style.display = 'none';
      backgroundMusic.play();
      if(gameMode === "niveles") {
        levelStartTime = Date.now();
      }
    }

    /* ================= Actualización y Dibujo ================= */
    function update() {
      if (gameState === 'playing') {
        // Movimiento del cohete
        if (keys['ArrowUp'] && astronaut.y - astronaut.size > 0) astronaut.y -= astronaut.speed;
        if (keys['ArrowDown'] && astronaut.y + astronaut.size < canvas.height) astronaut.y += astronaut.speed;
        
        if(gameMode === "score") {
          score++;
          // Reproducir sonido de récord (si se supera el highScore)
          if (score > highScore && !recordBeaten) {
            recordBeaten = true;
            playVictorySound();
          }
        } else if(gameMode === "niveles") {
          // En modo niveles, calculamos el tiempo transcurrido
          let elapsed = (Date.now() - levelStartTime) / 1000;
          if (elapsed >= targetTime) {
            winLevel();
            return;
          }
        }

        // Dificultad progresiva: velocidad de meteoritos
        const asteroidSpeed = 5 + (gameMode === "score" ? score : ((Date.now() - levelStartTime) / 1000)) * 0.001;

        // Actualizar meteoritos
        for (let i = 0; i < asteroids.length; i++) {
          asteroids[i].x -= asteroidSpeed;
          // Detección de colisión (rectángulo aproximado)
          if (
            astronaut.x - astronaut.size < asteroids[i].x + asteroids[i].size &&
            astronaut.x + astronaut.size > asteroids[i].x - asteroids[i].size &&
            astronaut.y - astronaut.size < asteroids[i].y + asteroids[i].size &&
            astronaut.y + astronaut.size > asteroids[i].y - asteroids[i].size
          ) {
            // En modo niveles, la colisión muestra Game Over; de lo contrario, se reinicia la partida
            gameOver();
            return;
          }
          // Eliminar meteoritos fuera de pantalla
          if (asteroids[i].x + asteroids[i].size < 0) {
            asteroids.splice(i, 1);
            i--;
          }
        }
        // Crear nuevos meteoritos aleatoriamente
        if (Math.random() < 0.03 + (gameMode === "score" ? score : ((Date.now() - levelStartTime) / 1000)) * 0.0001) {
          createAsteroid();
        }
      }
      // Actualizar estrellas (efecto parallax)
      for (const star of stars) {
        star.x -= star.speed;
        if (star.x < 0) {
          star.x = canvas.width;
          star.y = Math.random() * canvas.height;
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Dibujar fondo de estrellas
      ctx.fillStyle = 'white';
      for (const star of stars) {
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
        ctx.fill();
      }
      // Si se está jugando (playing o paused), dibujar cohete y meteoritos
      if (gameState === 'playing' || gameState === 'paused') {
        ctx.drawImage(astronautImg, astronaut.x - astronaut.size, astronaut.y - astronaut.size, astronaut.size * 2, astronaut.size * 2);
        for (const asteroid of asteroids) {
          ctx.drawImage(asteroid.img, asteroid.x - asteroid.size, asteroid.y - asteroid.size, asteroid.size * 2, asteroid.size * 2);
        }
        // Mostrar información en la esquina superior izquierda
        ctx.fillStyle = '#0F0';
        ctx.font = '20px Arial';
        if(gameMode === "score") {
          ctx.fillText('Puntuación: ' + score, 10, 30);
          ctx.fillText('Mejor: ' + highScore, 10, 60);
        } else if(gameMode === "niveles") {
          // Calcular tiempo transcurrido y formatearlo
          let elapsed = (Date.now() - levelStartTime) / 1000;
          ctx.fillText('Tu tiempo: ' + formatTime(elapsed), 10, 30);
          ctx.fillText('Tiempo a batir: ' + formatTime(targetTime), 10, 60);
        }
        // Si está en pausa, superponer mensaje
        if (gameState === 'paused') {
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = 'white';
          ctx.font = '40px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Pausa', canvas.width / 2, canvas.height / 2);
          ctx.textAlign = 'left';
        }
      }
    }

    // Función para crear un meteorito (selecciona imagen al azar)
    function createAsteroid() {
      const size = Math.random() * 30 + 10;
      const y = Math.random() * (canvas.height - size * 2) + size;
      const img = new Image();
      img.src = meteoriteImages[Math.floor(Math.random() * meteoriteImages.length)];
      asteroids.push({ x: canvas.width + size, y, size, img });
    }

    // Función para formatear tiempo (mm:ss:cc)
    function formatTime(timeSec) {
      let minutes = Math.floor(timeSec / 60);
      let seconds = Math.floor(timeSec % 60);
      let centiseconds = Math.floor((timeSec % 1) * 100);
      return (minutes < 10 ? "0" + minutes : minutes) + ":" +
             (seconds < 10 ? "0" + seconds : seconds) + ":" +
             (centiseconds < 10 ? "0" + centiseconds : centiseconds);
    }

    /* ================= Funciones de Fin de Juego ================= */
    // Game Over (por colisión)
    function gameOver() {
      collisionSound.play();
      gameState = 'gameover';
      backgroundMusic.pause();
      if(gameMode === "score") {
        if (score > highScore) {
          highScore = score;
          localStorage.setItem('highScore', highScore);
        }
        finalScoreText.textContent = 'Puntuación: ' + score + ' | Mejor: ' + highScore;
        gameOverMenu.style.display = 'block';
      } else {
        // En modo niveles, se usa la pantalla Game Over (se podría personalizar)
        finalScoreText.textContent = '¡Game Over!';
        gameOverMenu.style.display = 'block';
      }
    }

    // Victoria en modo niveles
    function winLevel() {
      gameState = 'win';
      backgroundMusic.pause();
      winMessage.textContent = 'Has conseguido pasarte el nivel ' + currentLevel;
      winMenu.style.display = 'block';
    }

    /* ================= Bucle del Juego ================= */
    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    /* ================= Actualización de Interfaces ================= */
    function updateUI() {
      if (gameState === 'start') {
        mainMenu.style.display = 'block';
        gameOverMenu.style.display = 'none';
        levelMenu.style.display = 'none';
        winMenu.style.display = 'none';
      } else if (gameState === 'playing' || gameState === 'paused') {
        mainMenu.style.display = 'none';
        gameOverMenu.style.display = 'none';
        helpScreen.style.display = 'none';
        levelMenu.style.display = 'none';
        winMenu.style.display = 'none';
      }
    }

    /* ================= Eventos de Botones ================= */
    helpButton.addEventListener('click', () => {
      helpScreen.style.display = 'block';
      mainMenu.style.display = 'none';
    });
    closeHelp.addEventListener('click', () => {
      helpScreen.style.display = 'none';
      mainMenu.style.display = 'block';
    });
    playButton.addEventListener('click', () => {
      gameMode = "score";
      startGame();
    });
    // Al pulsar "Jugar con niveles" en el menú principal, se muestra la pantalla de selección de niveles
    levelButton.addEventListener('click', () => {
      mainMenu.style.display = 'none';
      // Actualizamos la información de nivel
      levelInfo.innerHTML = "Nivel actual: " + currentLevel + "<br>Próximo objetivo: " + formatTime(getTargetTimeForLevel(currentLevel));
      levelMenu.style.display = 'block';
    });
    levelBackButton.addEventListener('click', () => {
      levelMenu.style.display = 'none';
      mainMenu.style.display = 'block';
    });
    levelPlayButton.addEventListener('click', () => {
      gameMode = "niveles";
      targetTime = getTargetTimeForLevel(currentLevel);
      startGame();
    });
    menuButton.addEventListener('click', () => {
      gameState = 'start';
      backgroundMusic.pause();
      mainMenu.style.display = 'block';
      gameOverMenu.style.display = 'none';
      winMenu.style.display = 'none';
    });
    retryButton.addEventListener('click', () => {
      startGame();
    });
    winMenuButton.addEventListener('click', () => {
      // Volver al menú principal desde la victoria
      gameState = 'start';
      winMenu.style.display = 'none';
      mainMenu.style.display = 'block';
      backgroundMusic.pause();
    });
    nextLevelButton.addEventListener('click', () => {
      // Incrementar nivel y reiniciar partida en modo niveles
      currentLevel++;
      targetTime = getTargetTimeForLevel(currentLevel);
      winMenu.style.display = 'none';
      startGame();
    });
    pauseButton.addEventListener('click', () => {
      if (gameState === 'playing' || gameState === 'paused') togglePause();
    });

    // Función para pausar/reanudar
    function togglePause() {
      if (gameState === 'playing') {
        gameState = 'paused';
        backgroundMusic.pause();
      } else if (gameState === 'paused') {
        gameState = 'playing';
        backgroundMusic.play();
      }
      updateUI();
    }

    /* ================= Inicio del Bucle del Juego ================= */
    gameLoop();
  </script>
</body>
</html>
