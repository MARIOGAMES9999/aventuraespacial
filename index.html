<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aventura Espacial</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
    }
    #pauseButton {
      position: fixed;
      top: 10px;
      right: 10px;
      cursor: pointer;
      z-index: 2;
    }
    .screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      z-index: 3;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      border: 2px solid white;
      display: none;
    }
    .screen button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    .menu-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .rocket-option {
      cursor: pointer;
      margin: 10px;
      border: 2px solid transparent;
    }
    .rocket-option.selected {
      border-color: yellow;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <img id="pauseButton" src="https://uxwing.com/wp-content/themes/uxwing/download/controller-and-music/pause-button-round-white-icon.png" alt="Pause Button" width="30" height="30">

  <!-- Menú Principal -->
  <div id="mainMenu" class="screen" style="display: block;">
    <h1>Aventura Espacial</h1>
    <div class="menu-buttons">
      <button id="helpButton">Ayuda</button>
      <button id="playButton">Jugar</button>
      <button id="levelButton">Jugar con niveles</button>
      <button id="customButton">Personalizar</button>
      <button id="configButton">Configuración</button>
    </div>
    <p>Presiona ENTER para comenzar</p>
  </div>

  <!-- Pantalla de Ayuda -->
  <div id="helpScreen" class="screen">
    <h2>Cómo jugar</h2>
    <p>
      Mueve el cohete usando las flechas arriba y abajo, o arrastrando la parte superior o inferior en móviles (o usando la rueda del ratón).<br>
      Cuando cambies la dirección vertical:<br>
      • Si te mueves hacia abajo, el cohete gira 90º a la derecha.<br>
      • Si te mueves hacia arriba, se muestra la imagen original.
    </p>
    <p>Funciones del juego:</p>
    <ul style="text-align: left;">
      <li><strong>Pausa:</strong> Usa el botón de pausa o la tecla "p".</li>
      <li><strong>Dificultad progresiva:</strong> Los meteoritos se aceleran con el tiempo.</li>
      <li><strong>Modo niveles:</strong> Sobrevive hasta alcanzar el tiempo objetivo.</li>
      <li><strong>Personalización:</strong> Cambia el diseño de tu cohete.</li>
    </ul>
    <button id="closeHelp">Cerrar</button>
  </div>

  <!-- Pantalla de Configuración -->
  <div id="configScreen" class="screen">
    <h2>Configuración</h2>
    <div class="menu-buttons">
      <button id="toggleRecord">Guardar Récord: ON</button>
      <button id="toggleFixedRotation">Fijar rotación del cohete: OFF</button>
      <button id="toggleMusic">Activar música: ON</button>
    </div>
    <button id="configBackButton">Volver</button>
  </div>

  <!-- Pantalla de Game Over -->
  <div id="gameOverMenu" class="screen">
    <h1>¡Game Over!</h1>
    <p id="finalScore"></p>
    <div class="menu-buttons">
      <button id="menuButton">Volver al menú principal</button>
      <button id="retryButton">Volver a intentar</button>
    </div>
  </div>

  <!-- Menú para Jugar con Niveles -->
  <div id="levelMenu" class="screen">
    <h2>Jugar con niveles</h2>
    <p id="levelInfo"></p>
    <div class="menu-buttons">
      <button id="levelBackButton">Volver</button>
      <button id="levelPlayButton">Jugar</button>
    </div>
  </div>

  <!-- Pantalla de Victoria en Modo Niveles -->
  <div id="winMenu" class="screen">
    <h1>¡FELICIDADES!</h1>
    <p id="winMessage"></p>
    <div class="menu-buttons">
      <button id="winMenuButton">Menú principal</button>
      <button id="nextLevelButton">Siguiente nivel</button>
    </div>
  </div>

  <!-- Pantalla de Personalización -->
  <div id="customizationScreen" class="screen">
    <h2>Personaliza tu cohete</h2>
    <p>Elige el diseño de tu cohete:</p>
    <div class="menu-buttons">
      <img class="rocket-option" data-src="https://cdn-icons-png.flaticon.com/512/3655/3655645.png" src="https://cdn-icons-png.flaticon.com/512/3655/3655645.png" alt="Opción 1" width="50" height="50">
      <img class="rocket-option" data-src="https://images.vexels.com/content/145821/preview/rocket-illustration-rocket-illustration-6e1e4f.png" src="https://images.vexels.com/content/145821/preview/rocket-illustration-rocket-illustration-6e1e4f.png" alt="Opción 2" width="50" height="50">
      <img class="rocket-option" data-src="https://images.vexels.com/media/users/3/152644/isolated/preview/8c827f1a2c4a228c86189825a8e625ed-icono-de-dibujos-animados-de-cohete-espacial.png" src="https://images.vexels.com/media/users/3/152644/isolated/preview/8c827f1a2c4a228c86189825a8e625ed-icono-de-dibujos-animados-de-cohete-espacial.png" alt="Opción 3" width="50" height="50">
      <img class="rocket-option" data-src="https://static.vecteezy.com/system/resources/previews/039/324/430/non_2x/startup-rocket-3d-render-free-png.png" src="https://static.vecteezy.com/system/resources/previews/039/324/430/non_2x/startup-rocket-3d-render-free-png.png" alt="Opción 4" width="50" height="50">
    </div>
    <button id="customBackButton">Volver</button>
  </div>

  <script>
    // Objeto de configuración
    let config = {
      saveRecord: true,
      fixedRotation: false,
      musicActive: true
    };

    /* ================= Variables Globales ================= */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Variable para la rotación del cohete
    let rocketAngle = 0;

    // Elementos de interfaz
    const pauseButton = document.getElementById('pauseButton');
    const mainMenu = document.getElementById('mainMenu');
    const helpScreen = document.getElementById('helpScreen');
    const configScreen = document.getElementById('configScreen');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const levelMenu = document.getElementById('levelMenu');
    const winMenu = document.getElementById('winMenu');
    const customizationScreen = document.getElementById('customizationScreen');

    const helpButton = document.getElementById('helpButton');
    const playButton = document.getElementById('playButton');
    const levelButton = document.getElementById('levelButton');
    const customButton = document.getElementById('customButton');
    const configButton = document.getElementById('configButton');
    const closeHelp = document.getElementById('closeHelp');
    const menuButton = document.getElementById('menuButton');
    const retryButton = document.getElementById('retryButton');
    const levelBackButton = document.getElementById('levelBackButton');
    const levelPlayButton = document.getElementById('levelPlayButton');
    const winMenuButton = document.getElementById('winMenuButton');
    const nextLevelButton = document.getElementById('nextLevelButton');
    const customBackButton = document.getElementById('customBackButton');
    const configBackButton = document.getElementById('configBackButton');

    const toggleRecord = document.getElementById('toggleRecord');
    const toggleFixedRotation = document.getElementById('toggleFixedRotation');
    const toggleMusic = document.getElementById('toggleMusic');

    const levelInfo = document.getElementById('levelInfo');
    const finalScoreText = document.getElementById('finalScore');
    const winMessage = document.getElementById('winMessage');

    let gameMode = "score";
    let gameState = 'start';

    let score = 0;
    let highScore = Number(localStorage.getItem('highScore')) || 0;
    let recordBeaten = false;

    let currentLevel = 1;
    let targetTime = 10;
    let levelStartTime = null;

    function getTargetTimeForLevel(level) {
      if(level === 1) return 10;
      if(level === 2) return 15;
      if(level === 3) return 20;
      if(level === 4) return 30;
      if(level === 5) return 40;
      if(level === 6) return 50;
      if(level === 7) return 60;
      if(level === 8) return 75;
      if(level === 9) return 90;
      if(level === 10) return 105;
      return getTargetTimeForLevel(10) + 15 * (level - 10);
    }

    const astronautImg = new Image();
    astronautImg.src = localStorage.getItem('rocketSkin') || "https://cdn-icons-png.flaticon.com/512/3655/3655645.png";

    const meteoriteImages = [
      "https://images.vexels.com/media/users/3/203018/isolated/preview/66f32f88385888d8827e7da298df6b77-ilustracion-de-roca-asteroide.png",
      "https://images.vexels.com/media/users/3/203017/isolated/preview/a6684989a6b4564caa310397c9b120af-ilustracion-de-la-orbita-de-un-asteroide.png",
      "https://images.vexels.com/media/users/3/203377/isolated/preview/0aec84665568ad2cda7a4a457eb27410-ilustracion-de-asteroide-de-roca.png",
      "https://images.vexels.com/media/users/3/205156/isolated/preview/97f52f15ce49dcd73b9678708f28cabf-ilustracion-de-la-orbita-de-la-roca-del-asteroide.png"
    ];

    const astronaut = {
      x: 100,
      y: canvas.height / 2,
      size: 30,
      speed: 5
    };

    let asteroids = [];
    let stars = [];
    let particles = [];
    createStars(100);

    const backgroundMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
    backgroundMusic.loop = true;
    backgroundMusic.volume = 0.2;
    const collisionSound = new Audio('https://www.soundjay.com/misc/sounds/fail-buzzer-01.mp3');
    collisionSound.volume = 0.5;
    const victorySound = new Audio('https://www.soundjay.com/button/sounds/button-3.mp3');
    victorySound.volume = 0.7;
    function playVictorySound() {
      if(config.musicActive) {
        victorySound.currentTime = 0;
        victorySound.play();
        setTimeout(() => {
          victorySound.pause();
          victorySound.currentTime = 0;
        }, 2000);
      }
    }

    const keys = {};

    /* ================= Controles Táctiles, de Arrastre y Rueda ================= */
    let dragging = false;
    let dragOffset = 0;
    canvas.addEventListener('touchstart', function(e) {
      dragging = true;
      dragOffset = astronaut.y - e.touches[0].clientY;
    });
    canvas.addEventListener('touchmove', function(e) {
      if (dragging) {
        let newY = e.touches[0].clientY + dragOffset;
        if(newY > astronaut.y) {
          rocketAngle = Math.PI / 2;
        } else if(newY < astronaut.y) {
          rocketAngle = 0;
        }
        astronaut.y = Math.max(astronaut.size, Math.min(newY, canvas.height - astronaut.size));
      }
    });
    canvas.addEventListener('touchend', function() {
      dragging = false;
    });
    canvas.addEventListener('wheel', function(e) {
      if(e.deltaY > 0) {
        rocketAngle = Math.PI / 2;
      } else if(e.deltaY < 0) {
        rocketAngle = 0;
      }
      astronaut.y += e.deltaY * 0.1;
      astronaut.y = Math.max(astronaut.size, Math.min(astronaut.y, canvas.height - astronaut.size));
    });

    /* ================= Funciones para Partículas ================= */
    function createExplosion(x, y) {
      for (let i = 0; i < 20; i++) {
        let angle = Math.random() * Math.PI * 2;
        let speed = Math.random() * 3 + 2;
        particles.push({
          x: x,
          y: y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          life: 60,
          color: 'orange'
        });
      }
    }
    function updateParticles() {
      for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        if (p.life <= 0) particles.splice(i, 1);
      }
    }
    function drawParticles() {
      for (let p of particles) {
        ctx.fillStyle = p.color;
        ctx.globalAlpha = Math.max(p.life / 60, 0);
        ctx.beginPath();
        ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    /* ================= Funciones de Inicio y Reinicio ================= */
    function createStars(num) {
      stars = [];
      for (let i = 0; i < num; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 2,
          speed: Math.random() * 0.5 + 0.2
        });
      }
    }
    function resetGame() {
      if (gameMode === "score") {
        score = 0;
        recordBeaten = false;
      }
      asteroids = [];
      astronaut.y = canvas.height / 2;
      keys['ArrowUp'] = false;
      keys['ArrowDown'] = false;
      if (gameMode === "niveles") {
        levelStartTime = Date.now();
      }
      particles = [];
    }
    function startGame() {
      resetGame();
      gameState = 'playing';
      mainMenu.style.display = 'none';
      gameOverMenu.style.display = 'none';
      helpScreen.style.display = 'none';
      levelMenu.style.display = 'none';
      winMenu.style.display = 'none';
      customizationScreen.style.display = 'none';
      if(config.musicActive) {
        backgroundMusic.play();
      } else {
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
      }
      if (gameMode === "niveles") levelStartTime = Date.now();
    }

    /* ================= Funciones de Actualización y Dibujo ================= */
    function update() {
      if (gameState === 'playing') {
        if (keys['ArrowUp'] && astronaut.y - astronaut.size > 0) {
          rocketAngle = 0;
          astronaut.y -= astronaut.speed;
        }
        if (keys['ArrowDown'] && astronaut.y + astronaut.size < canvas.height) {
          rocketAngle = Math.PI / 2;
          astronaut.y += astronaut.speed;
        }
        if (config.fixedRotation) {
          rocketAngle = 0;
        }
        if (gameMode === "score") {
          score++;
          if (score > highScore && !recordBeaten && config.saveRecord) {
            recordBeaten = true;
            playVictorySound();
          }
        } else if (gameMode === "niveles") {
          let elapsed = (Date.now() - levelStartTime) / 1000;
          if (elapsed >= targetTime) { winLevel(); return; }
        }
        const asteroidSpeed = 5 + (gameMode === "score" ? score : ((Date.now() - levelStartTime) / 1000)) * 0.001;
        for (let i = 0; i < asteroids.length; i++) {
          asteroids[i].x -= asteroidSpeed;
          const rocketCollisionSize = astronaut.size * 0.7;
          if (
            astronaut.x - rocketCollisionSize < asteroids[i].x + asteroids[i].size &&
            astronaut.x + rocketCollisionSize > asteroids[i].x - asteroids[i].size &&
            astronaut.y - rocketCollisionSize < asteroids[i].y + asteroids[i].size &&
            astronaut.y + rocketCollisionSize > asteroids[i].y - asteroids[i].size
          ) {
            createExplosion(astronaut.x, astronaut.y);
            gameOver();
            return;
          }
          if (asteroids[i].x + asteroids[i].size < 0) { asteroids.splice(i, 1); i--; }
        }
        if (Math.random() < 0.03 + (gameMode === "score" ? score : ((Date.now() - levelStartTime) / 1000)) * 0.0001) {
          createAsteroid();
        }
      }
      updateParticles();
      for (const star of stars) {
        star.x -= star.speed;
        if (star.x < 0) { star.x = canvas.width; star.y = Math.random() * canvas.height; }
      }
    }
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'white';
      for (const star of stars) {
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
        ctx.fill();
      }
      if (gameState === 'playing' || gameState === 'paused') {
        ctx.save();
        ctx.translate(astronaut.x, astronaut.y);
        ctx.rotate(rocketAngle);
        ctx.drawImage(astronautImg, -astronaut.size, -astronaut.size, astronaut.size * 2, astronaut.size * 2);
        ctx.restore();
        for (const asteroid of asteroids) {
          ctx.drawImage(asteroid.img, asteroid.x - asteroid.size, asteroid.y - asteroid.size, asteroid.size * 2, asteroid.size * 2);
        }
        ctx.fillStyle = '#0F0';
        ctx.font = '20px Arial';
        if (gameMode === "score") {
          ctx.fillText('Puntuación: ' + score, 10, 30);
          if(config.saveRecord) {
            ctx.fillText('Mejor: ' + highScore, 10, 60);
          }
        } else if (gameMode === "niveles") {
          let elapsed = (Date.now() - levelStartTime) / 1000;
          ctx.fillText('Tu tiempo: ' + formatTime(elapsed), 10, 30);
          ctx.fillText('Tiempo a batir: ' + formatTime(targetTime), 10, 60);
        }
        if (gameState === 'paused') {
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = 'white';
          ctx.font = '40px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Pausa', canvas.width / 2, canvas.height / 2);
          ctx.textAlign = 'left';
        }
      }
      drawParticles();
    }
    function createAsteroid() {
      const size = Math.random() * 30 + 10;
      const y = Math.random() * (canvas.height - size * 2) + size;
      const img = new Image();
      img.src = meteoriteImages[Math.floor(Math.random() * meteoriteImages.length)];
      asteroids.push({ x: canvas.width + size, y, size, img });
    }
    function formatTime(timeSec) {
      let minutes = Math.floor(timeSec / 60);
      let seconds = Math.floor(timeSec % 60);
      let centiseconds = Math.floor((timeSec % 1) * 100);
      return (minutes < 10 ? "0" + minutes : minutes) + ":" +
             (seconds < 10 ? "0" + seconds : seconds) + ":" +
             (centiseconds < 10 ? "0" + centiseconds : centiseconds);
    }
    function gameOver() {
      // Solo reproducir sonido de colisión si la música está activada
      if(config.musicActive) {
        collisionSound.play();
      }
      gameState = 'gameover';
      backgroundMusic.pause();
      if (gameMode === "score") {
        if (score > highScore && config.saveRecord) { highScore = score; localStorage.setItem('highScore', highScore); }
        finalScoreText.textContent = 'Puntuación: ' + score + (config.saveRecord ? ' | Mejor: ' + highScore : '');
        gameOverMenu.style.display = 'block';
      } else {
        finalScoreText.textContent = '¡Game Over!';
        gameOverMenu.style.display = 'block';
      }
    }
    function winLevel() {
      gameState = 'win';
      backgroundMusic.pause();
      winMessage.textContent = 'Has conseguido pasarte el nivel ' + currentLevel;
      winMenu.style.display = 'block';
    }
    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }
    function updateUI() {
      if (gameState === 'start') {
        mainMenu.style.display = 'block';
        gameOverMenu.style.display = 'none';
        levelMenu.style.display = 'none';
        winMenu.style.display = 'none';
        helpScreen.style.display = 'none';
        customizationScreen.style.display = 'none';
        configScreen.style.display = 'none';
      } else if (gameState === 'playing' || gameState === 'paused') {
        mainMenu.style.display = 'none';
        gameOverMenu.style.display = 'none';
        helpScreen.style.display = 'none';
        levelMenu.style.display = 'none';
        winMenu.style.display = 'none';
        customizationScreen.style.display = 'none';
        configScreen.style.display = 'none';
      }
    }

    /* ================= Eventos de Botones ================= */
    helpButton.addEventListener('click', () => { helpScreen.style.display = 'block'; mainMenu.style.display = 'none'; });
    closeHelp.addEventListener('click', () => { helpScreen.style.display = 'none'; mainMenu.style.display = 'block'; });
    playButton.addEventListener('click', () => { gameMode = "score"; startGame(); });
    levelButton.addEventListener('click', () => {
      mainMenu.style.display = 'none';
      levelInfo.innerHTML = "Nivel actual: " + currentLevel + "<br>Próximo objetivo: " + formatTime(getTargetTimeForLevel(currentLevel));
      levelMenu.style.display = 'block';
    });
    levelBackButton.addEventListener('click', () => { levelMenu.style.display = 'none'; mainMenu.style.display = 'block'; });
    levelPlayButton.addEventListener('click', () => { gameMode = "niveles"; targetTime = getTargetTimeForLevel(currentLevel); startGame(); });
    menuButton.addEventListener('click', () => { gameState = 'start'; backgroundMusic.pause(); mainMenu.style.display = 'block'; gameOverMenu.style.display = 'none'; winMenu.style.display = 'none'; });
    retryButton.addEventListener('click', () => { startGame(); });
    winMenuButton.addEventListener('click', () => { gameState = 'start'; winMenu.style.display = 'none'; mainMenu.style.display = 'block'; backgroundMusic.pause(); });
    nextLevelButton.addEventListener('click', () => { currentLevel++; targetTime = getTargetTimeForLevel(currentLevel); winMenu.style.display = 'none'; startGame(); });
    customButton.addEventListener('click', () => { mainMenu.style.display = 'none'; customizationScreen.style.display = 'block'; });
    customBackButton.addEventListener('click', () => { customizationScreen.style.display = 'none'; mainMenu.style.display = 'block'; });
    configButton.addEventListener('click', () => { mainMenu.style.display = 'none'; configScreen.style.display = 'block'; });
    configBackButton.addEventListener('click', () => { configScreen.style.display = 'none'; mainMenu.style.display = 'block'; });
    
    toggleRecord.addEventListener('click', () => {
      config.saveRecord = !config.saveRecord;
      if (!config.saveRecord) {
        highScore = 0;
        localStorage.removeItem('highScore');
        toggleRecord.textContent = "Guardar Récord: OFF";
      } else {
        toggleRecord.textContent = "Guardar Récord: ON";
      }
    });
    toggleFixedRotation.addEventListener('click', () => {
      config.fixedRotation = !config.fixedRotation;
      toggleFixedRotation.textContent = config.fixedRotation ? "Fijar rotación del cohete: ON" : "Fijar rotación del cohete: OFF";
    });
    toggleMusic.addEventListener('click', () => {
      config.musicActive = !config.musicActive;
      toggleMusic.textContent = config.musicActive ? "Activar música: ON" : "Activar música: OFF";
      if (!config.musicActive) {
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
      } else {
        if (gameState === 'playing') backgroundMusic.play();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (gameState === 'start' && e.key === 'Enter') startGame();
      else if (gameState === 'gameover' && e.key === 'Enter') startGame();
      else if (gameState === 'playing') {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
          if (e.key === 'ArrowUp') {
            rocketAngle = 0;
          } else if (e.key === 'ArrowDown') {
            rocketAngle = Math.PI / 2;
          }
          keys[e.key] = true;
        }
        if (e.key === 'p' || e.key === 'P') togglePause();
      } else if (gameState === 'paused') {
        if (e.key === 'p' || e.key === 'P') togglePause();
      }
      updateUI();
    });
    document.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') keys[e.key] = false;
    });
    function togglePause() {
      if (gameState === 'playing') { gameState = 'paused'; backgroundMusic.pause(); }
      else if (gameState === 'paused') { gameState = 'playing'; if(config.musicActive) backgroundMusic.play(); }
      updateUI();
    }

    const rocketOptions = document.querySelectorAll('.rocket-option');
    rocketOptions.forEach(option => {
      option.addEventListener('click', () => {
        rocketOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        const selectedSrc = option.getAttribute('data-src');
        astronautImg.src = selectedSrc;
        localStorage.setItem('rocketSkin', selectedSrc);
      });
    });

    gameLoop();
  </script>
</body>
</html>
